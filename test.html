<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Points on a map</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!-- mapbox plugins -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 50px;
        bottom: 0;
        width: 100%;
      }
      .address {
        font-size: 8px;
      }
    </style>
  </head>
  <body>
    <style>
      .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
      }
    </style>
    <!-- form to get user input -->
    <form id="movie-form">
      <label for="location-input">Search Location</label>
      <input type="text" id="location-input" />
      <label for="location-title">title</label>
      <input type="text" id="location-title" />
      <label for="location-desc">description</label>
      <input type="text" id="location-desc" />
      <input id="find-location" type="submit" value="Location Search" />
    </form>
    <!-- clear button -->
    <div>
      <button id="clear">Clear map</button>
    </div>

    <div id="map"></div>

    <script>
      // empty array that will hope all the marker id's
      const titlesArr = [];

      // creating the map and centered on seattle
      mapboxgl.accessToken =
        "pk.eyJ1IjoidmIyNyIsImEiOiJjazk4cjdteTgwNDNiM21xdHQ1Y3BtbWhyIn0.oyEQCIxSrbYI1VZ208kcPw";
      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/vb27/ck98rwfum06mc1ikcz89mqepw",
        center: [-122.3321, 47.6062],
        zoom: 7,
        maxzoom: 7,
      });

      // on click function once all the info is entered
      $("#find-location").on("click", function (event) {
        event.preventDefault();

        var location = $("#location-input").val();
        var desc = $("#location-desc").val();
        var title = $("#location-title").val();

        titlesArr.push(title);
        // api URL and ajax call
        var queryURL =
          "https://api.mapbox.com/geocoding/v5/mapbox.places/" +
          location +
          ".json?proximity=-122.27995,47.88047&access_token=pk.eyJ1IjoidmIyNyIsImEiOiJjazk4cjdteTgwNDNiM21xdHQ1Y3BtbWhyIn0.oyEQCIxSrbYI1VZ208kcPw";

        $.ajax({
          url: queryURL,
          method: "GET",
        }).then(function (response) {
          // console.log(response.features[0].center[0]); //long
          // console.log(response.features[0].center[1]); //lat
          // creating an object with all of the users info
          const newLocation = {
            title: title,
            desc: desc,
            long: response.features[0].center[0],
            lat: response.features[0].center[1],
            address: response.features[0].place_name
          };
          // giving the object to the newMap function
          newMap(newLocation);
        });

        // newMap function makes a maker with the information from the ajax call
        function newMap(newLocation) {
          map.loadImage("https://i.imgur.com/MK4NUzI.png", function (
            error,
            image
          ) {
            if (error) throw error;
            map.addImage("custom-marker", image);
            map.addLayer({
              maxzoom: 15,
              id: newLocation.title,
              type: "symbol",
              source: {
                type: "geojson",
                data: {
                  type: "FeatureCollection",
                  features: [
                    {
                      type: "Feature",
                      properties: {
                        description:
                          "<strong>" +
                          newLocation.title +
                          "</strong><p>" +
                          newLocation.desc +
                          "</p><p class='address'>"+newLocation.address+"</p>",
                      },
                      geometry: {
                        type: "Point",
                        coordinates: [newLocation.long, newLocation.lat],
                      },
                    },
                  ],
                },
              },
              layout: {
                "icon-image": "custom-marker",
                "icon-allow-overlap": true,
                "symbol-placement": "point",
                "icon-anchor": "bottom",
              },
            });
          });
        }

        // this is an on click function that is inside a loop so that there can be multiple id's with the same onclick
        for (i = 0; i < titlesArr.length; i++) {
          map.on("click", titlesArr[i], function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
              .setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);
          });
          // these last two on functions change the mouse from the hand to a pointer when they hover over a marker
          map.on("mouseenter", titlesArr[i], function () {
            map.getCanvas().style.cursor = "pointer";
          });

          map.on("mouseleave", titlesArr[i], function () {
            map.getCanvas().style.cursor = "";
          });
        }
      });

      // on click function that clears the board
        $("#clear").on("click", function () {
          for (i = 0; i < titlesArr.length; i++) {
            map.removeLayer(titlesArr[i]);
            map.removeSource(titlesArr[i])
          }
        });
      
    </script>
  </body>
</html>
